name: 'PHPCop Security Scanner'
description: 'Scan PHP dependencies for security vulnerabilities, outdated packages, and maintenance issues'
author: 'hfryan'

branding:
  icon: 'shield'
  color: 'red'

inputs:
  format:
    description: 'Output format (table, json, md, html, sarif)'
    required: false
    default: 'table'
  
  fail-on:
    description: 'Minimum severity to fail the build (low, moderate, high, critical)'
    required: false
    default: 'high'
  
  stale-months:
    description: 'Months to flag packages as stale'
    required: false
    default: '18'
  
  exclude-dev:
    description: 'Exclude dev dependencies from scan'
    required: false
    default: 'false'
  
  only-dev:
    description: 'Only scan dev dependencies'
    required: false
    default: 'false'
  
  min-severity:
    description: 'Minimum vulnerability severity to report (low, moderate, high, critical)'
    required: false
    default: 'low'
  
  ignore-packages:
    description: 'Comma-separated list of packages to ignore'
    required: false
    default: ''
  
  license-allowlist:
    description: 'Comma-separated list of allowed licenses'
    required: false
    default: ''
  
  license-denylist:
    description: 'Comma-separated list of denied licenses'
    required: false
    default: ''
  
  exit-code:
    description: 'Exit code behavior (legacy, enhanced)'
    required: false
    default: 'enhanced'
  
  comment-pr:
    description: 'Post scan results as PR comment'
    required: false
    default: 'true'
  
  upload-artifacts:
    description: 'Upload scan reports as artifacts'
    required: false
    default: 'true'
  
  working-directory:
    description: 'Working directory to run scan in'
    required: false
    default: '.'

outputs:
  exit-code:
    description: 'The exit code from PHPCop scan'
  
  issues-found:
    description: 'Number of issues found'
  
  vulnerabilities-found:
    description: 'Number of vulnerabilities found'
  
  report-file:
    description: 'Path to the generated report file'

runs:
  using: 'composite'
  steps:
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        coverage: none
        tools: composer
    
    - name: Build PHPCop PHAR from Source
      shell: bash
      run: |
        cd "${{ inputs.working-directory }}"
        echo "üî® Building PHPCop from source (testing mode)..."
        
        # For testing the GitHub Action, build from current source
        # In production, this would download from releases
        composer install --no-dev --optimize-autoloader
        php -d phar.readonly=0 build-phar.php
        
        # Verify PHAR was built correctly
        if [ -f "phpcop.phar" ] && [ $(stat -f%z phpcop.phar 2>/dev/null || stat -c%s phpcop.phar) -gt 1000000 ]; then
          echo "‚úÖ PHPCop PHAR built successfully ($(ls -lh phpcop.phar | awk '{print $5}'))"
          chmod +x phpcop.phar
        else
          echo "‚ùå PHPCop PHAR build failed or file too small"
          ls -la phpcop.phar
          exit 1
        fi
        
    - name: Verify composer.lock exists
      shell: bash
      run: |
        cd "${{ inputs.working-directory }}"
        if [ ! -f "composer.lock" ]; then
          echo "‚ùå composer.lock not found in ${{ inputs.working-directory }}"
          echo "üí° Make sure to run 'composer install' before PHPCop scan"
          exit 1
        fi
        echo "‚úÖ composer.lock found"
    
    - name: Run PHPCop Scan
      shell: bash
      id: scan
      run: |
        cd "${{ inputs.working-directory }}"
        
        # Build command arguments
        ARGS="--quiet"  # Use quiet mode for cleaner CI output
        [ "${{ inputs.format }}" != "table" ] && ARGS="$ARGS --format=${{ inputs.format }}"
        [ "${{ inputs.fail-on }}" != "high" ] && ARGS="$ARGS --fail-on=${{ inputs.fail-on }}"
        [ "${{ inputs.stale-months }}" != "18" ] && ARGS="$ARGS --stale-months=${{ inputs.stale-months }}"
        [ "${{ inputs.exclude-dev }}" = "true" ] && ARGS="$ARGS --exclude-dev"
        [ "${{ inputs.only-dev }}" = "true" ] && ARGS="$ARGS --only-dev"
        [ "${{ inputs.min-severity }}" != "low" ] && ARGS="$ARGS --min-severity=${{ inputs.min-severity }}"
        [ "${{ inputs.exit-code }}" != "enhanced" ] && ARGS="$ARGS --exit-code=${{ inputs.exit-code }}"
        [ -n "${{ inputs.ignore-packages }}" ] && ARGS="$ARGS --ignore-packages=${{ inputs.ignore-packages }}"
        [ -n "${{ inputs.license-allowlist }}" ] && ARGS="$ARGS --license-allowlist=${{ inputs.license-allowlist }}"
        [ -n "${{ inputs.license-denylist }}" ] && ARGS="$ARGS --license-denylist=${{ inputs.license-denylist }}"
        
        echo "üöì Running PHPCop Security Scan..."
        echo "Command: php phpcop.phar scan $ARGS"
        
        # Run scan and capture output
        SCAN_OUTPUT=$(php phpcop.phar scan $ARGS 2>&1) || SCAN_EXIT_CODE=$?
        SCAN_EXIT_CODE=${SCAN_EXIT_CODE:-0}
        
        # Debug exit code before cleaning
        echo "DEBUG: Raw exit code: '$SCAN_EXIT_CODE'"
        echo "DEBUG: Exit code hex dump: $(echo -n "$SCAN_EXIT_CODE" | xxd -p)"
        
        # Clean exit code (remove any whitespace but keep digits)
        SCAN_EXIT_CODE=$(echo "$SCAN_EXIT_CODE" | tr -d '\r\n \t')
        # If it's not a single digit 0-9, default to 0
        if [[ ! "$SCAN_EXIT_CODE" =~ ^[0-9]+$ ]]; then
          SCAN_EXIT_CODE=0
        fi
        
        # Debug after cleaning
        echo "DEBUG: Cleaned exit code: '$SCAN_EXIT_CODE'"
        
        # Save output to file
        echo "$SCAN_OUTPUT" > phpcop-output.txt
        
        # Generate reports in different formats for artifacts
        if [ "${{ inputs.upload-artifacts }}" = "true" ]; then
          echo "üìä Generating additional report formats..."
          php phpcop.phar scan --format=json --quiet > phpcop-report.json 2>/dev/null || true
          php phpcop.phar scan --format=md --quiet > phpcop-report.md 2>/dev/null || true
          php phpcop.phar scan --format=html --quiet > phpcop-report.html 2>/dev/null || true
        fi
        
        # Count issues for outputs (handle empty results properly)
        ISSUES_COUNT=$(echo "$SCAN_OUTPUT" | grep -c "^‚Ä¢" 2>/dev/null || echo "0")
        VULNS_COUNT=$(echo "$SCAN_OUTPUT" | grep -c "üö®" 2>/dev/null || echo "0")
        
        # Ensure counts are clean integers
        ISSUES_COUNT=$(echo "$ISSUES_COUNT" | tr -d '\r\n' | grep -o '[0-9]*' | head -1)
        VULNS_COUNT=$(echo "$VULNS_COUNT" | tr -d '\r\n' | grep -o '[0-9]*' | head -1)
        
        # Default to 0 if empty
        ISSUES_COUNT=${ISSUES_COUNT:-0}
        VULNS_COUNT=${VULNS_COUNT:-0}
        
        # Set GitHub Actions outputs
        echo "DEBUG: About to write outputs - SCAN_EXIT_CODE='$SCAN_EXIT_CODE'"
        echo "DEBUG: GITHUB_OUTPUT file: '$GITHUB_OUTPUT'"
        
        # Ensure exit code is set
        SCAN_EXIT_CODE=${SCAN_EXIT_CODE:-0}
        
        {
          echo "exit-code=$SCAN_EXIT_CODE"
          echo "issues-found=$ISSUES_COUNT"
          echo "vulnerabilities-found=$VULNS_COUNT"
          echo "report-file=phpcop-output.txt"
        } >> "$GITHUB_OUTPUT"
        
        echo "DEBUG: Outputs written to file"
        echo "DEBUG: Contents of GITHUB_OUTPUT:"
        cat "$GITHUB_OUTPUT" || echo "ERROR: Could not read GITHUB_OUTPUT file"
        
        # Display results
        echo "üìã Scan Results:"
        echo "   Exit Code: '$SCAN_EXIT_CODE' (length: ${#SCAN_EXIT_CODE})"
        echo "   Issues Found: $ISSUES_COUNT"
        echo "   Vulnerabilities: $VULNS_COUNT"
        
        # Show output
        echo ""
        echo "üìÑ Scan Output:"
        echo "$SCAN_OUTPUT"
        
        # Set exit code for workflow
        exit $SCAN_EXIT_CODE
    
    - name: Comment on PR
      if: github.event_name == 'pull_request' && inputs.comment-pr == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Read scan output
          const workingDir = '${{ inputs.working-directory }}';
          const outputPath = path.join(workingDir, 'phpcop-output.txt');
          
          if (!fs.existsSync(outputPath)) {
            console.log('‚ö†Ô∏è PHPCop output file not found, skipping PR comment');
            return;
          }
          
          const scanOutput = fs.readFileSync(outputPath, 'utf8');
          const exitCode = '${{ steps.scan.outputs.exit-code }}';
          const issuesFound = '${{ steps.scan.outputs.issues-found }}';
          const vulnsFound = '${{ steps.scan.outputs.vulnerabilities-found }}';
          
          // Determine status emoji and message
          let statusEmoji, statusMessage;
          switch(exitCode) {
            case '0':
              statusEmoji = '‚úÖ';
              statusMessage = 'No security issues found';
              break;
            case '1':
              statusEmoji = '‚ö†Ô∏è';
              statusMessage = 'Minor issues found (warnings)';
              break;
            case '2':
              statusEmoji = '‚ùå';
              statusMessage = 'Moderate issues found (errors)';
              break;
            case '3':
              statusEmoji = 'üö®';
              statusMessage = 'Critical security issues found';
              break;
            default:
              statusEmoji = '‚ùì';
              statusMessage = 'Scan completed with unknown status';
          }
          
          // Create comment body
          const commentBody = '## ' + statusEmoji + ' PHPCop Security Scan Results\n\n' +
            '**Status:** ' + statusMessage + '\n' +
            '**Exit Code:** ' + exitCode + '\n' +
            '**Issues Found:** ' + issuesFound + '\n' +
            '**Vulnerabilities:** ' + vulnsFound + '\n\n' +
            '<details>\n<summary>üìÑ Detailed Scan Results</summary>\n\n' +
            '```\n' + scanOutput + '\n```\n\n</details>\n\n' +
            '---\n*Scan performed by [PHPCop](https://github.com/hfryan/php-cop) üöì*';
          
          // Post comment
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });
          
          console.log('‚úÖ Posted PHPCop results to PR comment');
    
    - name: Upload Scan Reports
      if: inputs.upload-artifacts == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: phpcop-security-reports-${{ github.job }}-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          ${{ inputs.working-directory }}/phpcop-output.txt
          ${{ inputs.working-directory }}/phpcop-report.json
          ${{ inputs.working-directory }}/phpcop-report.md
          ${{ inputs.working-directory }}/phpcop-report.html
        retention-days: 30
        if-no-files-found: ignore